<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PALS - Patient Dashboard</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      display: flex;
      min-height: 100vh;
      background: #f4f6f9;
    }
    .sidebar {
      width: 280px;
      background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
      color: white;
      padding: 25px;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    .sidebar-header {
      text-align: center;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .sidebar-header h2 {
      margin: 0 0 5px;
      font-size: 20px;
    }
    .sidebar-header p {
      margin: 0;
      opacity: 0.7;
      font-size: 12px;
    }
    .profile-section {
      text-align: center;
      padding: 25px 0;
    }
    .profile-photo {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 4px solid rgba(255,255,255,0.2);
      object-fit: cover;
    }
    .profile-name {
      font-size: 18px;
      font-weight: 600;
      margin: 15px 0 5px;
    }
    .user-code {
      background: rgba(255,255,255,0.15);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      display: inline-block;
      margin-top: 10px;
    }
    .user-code span {
      font-weight: 700;
      color: #3498db;
    }
    .info-list {
      margin-top: 20px;
      padding: 0;
      list-style: none;
    }
    .info-list li {
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      font-size: 13px;
    }
    .info-list li:last-child { border-bottom: none; }
    .info-label {
      opacity: 0.7;
    }
    .info-value {
      font-weight: 500;
    }
    .logout-btn {
      margin-top: auto;
      padding: 12px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.2s;
    }
    .logout-btn:hover { background: #c0392b; }

    .main {
      flex: 1;
      margin-left: 280px;
      padding: 30px;
    }
    .welcome-banner {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 16px;
      margin-bottom: 30px;
    }
    .welcome-banner h1 {
      margin: 0 0 10px;
      font-size: 28px;
    }
    .welcome-banner p {
      margin: 0;
      opacity: 0.9;
      font-size: 15px;
    }

    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .stat-icon.blue { background: #e3f2fd; }
    .stat-icon.green { background: #e8f5e9; }
    .stat-icon.purple { background: #f3e5f5; }
    .stat-icon.orange { background: #fff3e0; }
    .stat-info h3 {
      margin: 0;
      font-size: 24px;
      color: #2c3e50;
    }
    .stat-info p {
      margin: 5px 0 0;
      color: #666;
      font-size: 13px;
    }

    .action-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    .action-card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    .action-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .action-card.add-prescription { border-color: #27ae60; }
    .action-card.add-prescription:hover { background: #f0fff4; }
    .action-card.view-prescriptions { border-color: #3498db; }
    .action-card.view-prescriptions:hover { background: #f0f8ff; }
    .action-card.manage-visibility { border-color: #9b59b6; }
    .action-card.manage-visibility:hover { background: #faf0ff; }
    .action-card.view-history { border-color: #e67e22; }
    .action-card.view-history:hover { background: #fff8f0; }
    .action-card.emergency { border-color: #c0392b; }
    .action-card.emergency:hover { background: #ffe6e6; }

    .action-icon {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-bottom: 20px;
    }
    .add-prescription .action-icon { background: #e8f5e9; }
    .view-prescriptions .action-icon { background: #e3f2fd; }
    .manage-visibility .action-icon { background: #f3e5f5; }
    .view-history .action-icon { background: #fff3e0; }

    .action-card h3 {
      margin: 0 0 10px;
      font-size: 18px;
      color: #2c3e50;
    }
    .action-card p {
      margin: 0;
      color: #666;
      font-size: 13px;
      line-height: 1.5;
    }
    .action-arrow {
      margin-top: 15px;
      color: #999;
      font-size: 20px;
    }

    .section-title {
      font-size: 20px;
      color: #2c3e50;
      margin: 30px 0 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section-title span { font-size: 24px; }

    .recent-prescriptions {
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .prescription-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    .prescription-item:last-child { margin-bottom: 0; }
    .prescription-date {
      background: #3498db;
      color: white;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      min-width: 60px;
    }
    .prescription-date .day { font-size: 20px; font-weight: 700; }
    .prescription-date .month { font-size: 11px; text-transform: uppercase; }
    .prescription-details { flex: 1; }
    .prescription-details h4 { margin: 0 0 5px; color: #2c3e50; }
    .prescription-details p { margin: 0; color: #666; font-size: 13px; }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #888;
    }
    .empty-state span { font-size: 48px; display: block; margin-bottom: 15px; }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>PALS</h2>
      <p>Patient Access & Logging System</p>
    </div>
    
    <div class="profile-section">
      <img id="profilePhoto" class="profile-photo" src="default.png" alt="Profile">
      <div class="profile-name" id="name"></div>
      <div class="user-code">Patient Code: <span id="code"></span></div>
    </div>
    
    <ul class="info-list">
      <li>
        <span class="info-label">Age</span>
        <span class="info-value" id="age"></span>
      </li>
      <li>
        <span class="info-label">Blood Group</span>
        <span class="info-value" id="bloodGroup"></span>
      </li>
      <li>
        <span class="info-label">Allergies</span>
        <span class="info-value" id="allergies"></span>
      </li>
      <li>
        <span class="info-label">Emergency</span>
        <span class="info-value" id="emergencyContact"></span>
      </li>
      <li>
        <span class="info-label">Email</span>
        <span class="info-value" id="email"></span>
      </li>
    </ul>
    
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="main">
    <div class="welcome-banner">
      <h1>Welcome back, <span id="welcomeName"></span>!</h1>
      <p>Manage your medical records, prescriptions, and privacy settings all in one place.</p>
    </div>

    <div class="quick-stats">
      <div class="stat-card">
        <div class="stat-icon blue">üìã</div>
        <div class="stat-info">
          <h3 id="prescriptionCount">0</h3>
          <p>Total Prescriptions</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green">üë®‚Äç‚öïÔ∏è</div>
        <div class="stat-info">
          <h3 id="doctorVisits">0</h3>
          <p>Doctor Visits</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon purple">üîí</div>
        <div class="stat-info">
          <h3 id="privateFields">0</h3>
          <p>Private Fields</p>
        </div>
      </div>
    </div>

    <div class="action-cards">
      <div class="action-card add-prescription" onclick="location.href='document_form.html'">
        <div class="action-icon">üìù</div>
        <h3>Add New Prescription</h3>
        <p>Upload and save your medical prescriptions with detailed health information.</p>
        <div class="action-arrow">‚Üí</div>
      </div>
      
      <div class="action-card view-prescriptions" onclick="location.href='prescription.html'">
        <div class="action-icon">üìö</div>
        <h3>View Prescriptions</h3>
        <p>Browse through your prescription history and uploaded documents.</p>
        <div class="action-arrow">‚Üí</div>
      </div>
      
      <div class="action-card manage-visibility" onclick="location.href='manage.html'">
        <div class="action-icon">üîê</div>
        <h3>Privacy Settings</h3>
        <p>Control which medical information doctors can access about you.</p>
        <div class="action-arrow">‚Üí</div>
      </div>
      
      <div class="action-card view-history" onclick="location.href='history.html'">
        <div class="action-icon">üìä</div>
        <h3>Doctor Visit History</h3>
        <p>See which doctors have viewed your medical records.</p>
        <div class="action-arrow">‚Üí</div>
      </div>
      
      <div class="action-card emergency" onclick="location.href='emergency.html'">
        <div class="action-icon">üö®</div>
        <h3>Emergency Assistance</h3>
        <p>Quick access to AI-powered emergency guidance and first aid.</p>
        <div class="action-arrow">‚Üí</div>
      </div>
    </div>

    <h2 class="section-title"><span>üìã</span> Recent Prescriptions</h2>
    <div class="recent-prescriptions">
      <div id="recentPrescriptions">
        <div class="empty-state">
          <span>üì≠</span>
          Loading prescriptions...
        </div>
      </div>
    </div>
  </div>

  <script>
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) {
      window.location.href = "index.html";
    } else {
      document.getElementById("name").innerText = user.name;
      document.getElementById("welcomeName").innerText = user.name.split(' ')[0];
      document.getElementById("age").innerText = user.age + ' years';
      document.getElementById("bloodGroup").innerText = user.bloodGroup;
      document.getElementById("allergies").innerText = user.allergies || "None";
      document.getElementById("emergencyContact").innerText = user.emergencyContact;
      document.getElementById("email").innerText = user.email;
      document.getElementById("code").innerText = user.code;

      document.getElementById("profilePhoto").src = user.profilePhoto && user.profilePhoto.trim() !== ""
        ? user.profilePhoto
        : "default.png";
    }

    function logout() {
      localStorage.removeItem("user");
      window.location.href = "index.html";
    }

    async function loadStats() {
      try {
        const prescRes = await fetch(`/prescription/${user.code}`);
        const prescriptions = await prescRes.json();
        document.getElementById("prescriptionCount").innerText = Array.isArray(prescriptions) ? prescriptions.length : 0;
        
        const container = document.getElementById("recentPrescriptions");
        if (Array.isArray(prescriptions) && prescriptions.length > 0) {
          container.innerHTML = '';
          prescriptions.slice(0, 3).forEach(p => {
            const date = new Date(p.date);
            const day = date.getDate();
            const month = date.toLocaleString('default', { month: 'short' });
            
            const item = document.createElement('div');
            item.className = 'prescription-item';
            item.innerHTML = `
              <div class="prescription-date">
                <div class="day">${day || '--'}</div>
                <div class="month">${month || '---'}</div>
              </div>
              <div class="prescription-details">
                <h4>${p.hospital || 'Medical Visit'}</h4>
                <p>${p.doctor ? 'Dr. ' + p.doctor : 'Doctor not specified'} ${p.diseases ? '‚Ä¢ ' + p.diseases.substring(0, 30) + '...' : ''}</p>
              </div>
            `;
            container.appendChild(item);
          });
        } else {
          container.innerHTML = `
            <div class="empty-state">
              <span>üì≠</span>
              No prescriptions yet. Add your first prescription!
            </div>
          `;
        }

        const histRes = await fetch(`/patient/history/${user.code}`);
        const history = await histRes.json();
        document.getElementById("doctorVisits").innerText = Array.isArray(history) ? history.length : 0;

        const visRes = await fetch(`/visibility/${user.code}`);
        const visibility = await visRes.json();
        const privateCount = Object.values(visibility).filter(v => v === 'private').length;
        document.getElementById("privateFields").innerText = privateCount;
      } catch (err) {
        console.error(err);
      }
    }

    loadStats();
  </script>
</body>
</html>
