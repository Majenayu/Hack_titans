<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PALS - Register</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #ff9966, #ff5e62);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .container {
      background: #fff;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 500px;
    }
    h2 {
      margin-bottom: 20px;
      text-align: center;
      color: #ff5e62;
    }
    select, input, textarea {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    button {
      width: 100%;
      padding: 12px;
      background: #ff5e62;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    button:hover {
      background: #d94a4f;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .link {
      display: block;
      text-align: center;
      margin-top: 15px;
      color: #ff5e62;
      text-decoration: none;
      font-size: 14px;
    }
    #msg {
      margin-top: 12px;
      font-weight: bold;
      text-align: center;
    }
    .prescription-upload {
      background: #f8f9fa;
      border: 2px dashed #ff5e62;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }
    .prescription-upload h3 {
      color: #ff5e62;
      margin: 0 0 10px 0;
      font-size: 16px;
    }
    .prescription-upload p {
      color: #666;
      font-size: 12px;
      margin: 5px 0;
    }
    .prescription-upload input[type="file"] {
      display: none;
    }
    .upload-btn {
      background: #ff5e62;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      display: inline-block;
      margin-top: 10px;
    }
    .upload-btn:hover {
      background: #d94a4f;
    }
    .extracted-info {
      background: #e8f5e9;
      border: 1px solid #4caf50;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      display: none;
    }
    .extracted-info h4 {
      color: #2e7d32;
      margin: 0 0 10px 0;
    }
    .extracted-info ul {
      margin: 0;
      padding-left: 20px;
      font-size: 13px;
      color: #333;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 15px;
      color: #ff5e62;
    }
    .loading.show {
      display: block;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #ff5e62;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .section-label {
      font-weight: bold;
      color: #666;
      font-size: 12px;
      margin-top: 15px;
      margin-bottom: 5px;
      text-transform: uppercase;
    }
    .medical-section {
      background: #fff8e1;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    .medical-section h4 {
      color: #f57c00;
      margin: 0 0 10px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Register - PALS</h2>
    
    <div class="prescription-upload">
      <h3>Upload Prescription/Medical Report</h3>
      <p>Upload a prescription image and we'll automatically fill your medical info</p>
      <label class="upload-btn" for="prescriptionFile">
        Choose Prescription Image
      </label>
      <input type="file" id="prescriptionFile" accept="image/*">
      <p id="prescriptionFileName" style="color: #4caf50; margin-top: 10px;"></p>
    </div>
    
    <div class="loading" id="loadingSpinner">
      <div class="spinner"></div>
      <p>Reading prescription... Please wait</p>
    </div>
    
    <div class="extracted-info" id="extractedInfo">
      <h4>Extracted Information</h4>
      <ul id="extractedList"></ul>
    </div>
    
    <form id="registerForm" enctype="multipart/form-data">
      <div class="section-label">Personal Information</div>
      <input type="text" name="name" id="name" placeholder="Full Name" required>
      <input type="number" name="age" id="age" placeholder="Age" required>

      <select name="bloodGroup" id="bloodGroup" required>
        <option value="">Select Blood Group</option>
        <option value="A+">A+</option>
        <option value="A-">A-</option>
        <option value="B+">B+</option>
        <option value="B-">B-</option>
        <option value="AB+">AB+</option>
        <option value="AB-">AB-</option>
        <option value="O+">O+</option>
        <option value="O-">O-</option>
      </select>

      <div class="section-label">Medical Information</div>
      <textarea name="allergies" id="allergies" placeholder="Allergies (e.g., Penicillin, Peanuts)"></textarea>
      <textarea name="medicalConditions" id="medicalConditions" placeholder="Existing Medical Conditions (e.g., Diabetes, Hypertension)"></textarea>
      <textarea name="currentMedications" id="currentMedications" placeholder="Current Medications (e.g., Metformin 500mg)"></textarea>

      <div class="section-label">Contact & Account</div>
      <input type="text" name="emergencyContact" id="emergencyContact" placeholder="Emergency Contact" required>
      <input type="email" name="email" id="email" placeholder="Email" required>
      <input type="password" name="password" id="password" placeholder="Password" required autocomplete="new-password">
      
      <div class="section-label">Profile Photo</div>
      <input type="file" name="photo" id="photo" accept="image/*" required>
      
      <button type="submit" id="submitBtn">Register</button>
    </form>
    <p id="msg"></p>
    <a class="link" href="index.html">Already have an account? Login</a>
  </div>

  <script>
  const prescriptionInput = document.getElementById('prescriptionFile');
  const prescriptionFileName = document.getElementById('prescriptionFileName');
  const loadingSpinner = document.getElementById('loadingSpinner');
  const extractedInfo = document.getElementById('extractedInfo');
  const extractedList = document.getElementById('extractedList');

  prescriptionInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    prescriptionFileName.textContent = file.name;
    loadingSpinner.classList.add('show');
    extractedInfo.style.display = 'none';

    const formData = new FormData();
    formData.append('image', file);

    try {
      const res = await fetch('/extract-prescription', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();

      loadingSpinner.classList.remove('show');

      if (data.extracted && Object.keys(data.extracted).length > 0) {
        const extracted = data.extracted;
        const items = [];

        if (extracted.bp) {
          items.push(`Blood Pressure: ${extracted.bp}`);
        }
        if (extracted.pulse) {
          items.push(`Pulse: ${extracted.pulse}`);
        }
        if (extracted.temperature) {
          items.push(`Temperature: ${extracted.temperature}`);
        }
        if (extracted.sugar) {
          items.push(`Blood Sugar: ${extracted.sugar}`);
        }
        if (extracted.cholesterol) {
          items.push(`Cholesterol: ${extracted.cholesterol}`);
        }
        if (extracted.diseases || extracted.diagnosis) {
          const conditions = extracted.diseases || extracted.diagnosis;
          document.getElementById('medicalConditions').value = conditions;
          items.push(`Medical Conditions: ${conditions}`);
        }
        if (extracted.medication || extracted.medications) {
          const meds = extracted.medication || extracted.medications;
          document.getElementById('currentMedications').value = meds;
          items.push(`Medications: ${meds}`);
        }
        if (extracted.history || extracted.medical_history) {
          const history = extracted.history || extracted.medical_history;
          if (document.getElementById('medicalConditions').value) {
            document.getElementById('medicalConditions').value += ', ' + history;
          } else {
            document.getElementById('medicalConditions').value = history;
          }
          items.push(`Medical History: ${history}`);
        }
        if (extracted.allergies) {
          document.getElementById('allergies').value = extracted.allergies;
          items.push(`Allergies: ${extracted.allergies}`);
        }

        if (items.length > 0) {
          extractedList.innerHTML = items.map(item => `<li>${item}</li>`).join('');
          extractedInfo.style.display = 'block';
        }

        if (data.message) {
          prescriptionFileName.textContent = file.name + ' - ' + data.message;
        }
      } else {
        prescriptionFileName.textContent = file.name + ' - ' + (data.message || 'No data could be extracted');
        prescriptionFileName.style.color = '#f44336';
      }
    } catch (err) {
      loadingSpinner.classList.remove('show');
      prescriptionFileName.textContent = file.name + ' - Error reading prescription';
      prescriptionFileName.style.color = '#f44336';
      console.error('Error extracting prescription:', err);
    }
  });

  document.getElementById("registerForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Registering...';

    const formData = new FormData(e.target);

    try {
      const res = await fetch("/register", {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      document.getElementById("msg").innerText =
        data.message + (data.code ? " | Code: " + data.code : "");
      document.getElementById("msg").style.color = data.error ? '#f44336' : '#4caf50';
      
      if (!data.error) {
        e.target.reset();
        prescriptionFileName.textContent = '';
        extractedInfo.style.display = 'none';
      }
    } catch (err) {
      document.getElementById("msg").innerText = "Error registering user.";
      document.getElementById("msg").style.color = '#f44336';
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Register';
    }
  });
</script>

</body>
</html>
